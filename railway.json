{
  "$schema": "https://railway.app/railway.schema.json",
  "services": {
    "postgres": {
      "image": "postgres:15-alpine",
      "variables": {
        "POSTGRES_DB": "myfamily_db",
        "POSTGRES_USER": "admin",
        "POSTGRES_PASSWORD": "${{ secrets.DATABASE_PASSWORD }}"
      },
      "volumes": [
        {
          "name": "postgres_data",
          "mountPath": "/var/lib/postgresql/data"
        }
      ]
    },
    "backend": {
      "build": {
        "context": "./backend/myfamily",
        "dockerfile": "Dockerfile.prod"
      },
      "variables": {
        "SPRING_PROFILES_ACTIVE": "prod",
        "DATABASE_URL": "${{ services.postgres.connectionString }}/myfamily_db",
        "DATABASE_USER": "admin",
        "DATABASE_PASSWORD": "${{ secrets.DATABASE_PASSWORD }}",
        "JWT_SECRET": "${{ secrets.JWT_SECRET }}",
        "ALLOWED_ORIGINS": "https://${{ services.frontend.domain }}"
      },
      "healthcheck": {
        "test": [
          "CMD",
          "curl",
          "-f",
          "http://localhost:8080/api/actuator/health"
        ],
        "interval": 30,
        "timeout": 10,
        "retries": 3,
        "startPeriod": 40
      },
      "ports": [
        {
          "containerPort": 8080,
          "publicPort": 8080
        }
      ]
    },
    "frontend": {
      "build": {
        "context": "./frontend/myFamily",
        "dockerfile": "Dockerfile.prod"
      },
      "variables": {
        "NG_APP_API_URL": "https://${{ services.backend.domain }}/api"
      },
      "ports": [
        {
          "containerPort": 80,
          "publicPort": 80
        }
      ]
    }
  }
}
