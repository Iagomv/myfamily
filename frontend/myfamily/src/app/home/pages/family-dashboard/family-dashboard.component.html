<ion-page>
  <app-header [title]="'Dashboard'" [icon]="'home-outline'" [color]="'header-toolbar'">
  </app-header>

  <ion-content class="ion-padding" [scrollY]="true" style="--padding-bottom: 85px;">
    <div class="dashboard-container">
      <ng-container *ngIf="isLoading">
        <ion-card>
          <ion-card-content>Cargando...</ion-card-content>
        </ion-card>
      </ng-container>

      <ng-container *ngIf="!isLoading && loadError">
        <ion-card>
          <ion-card-content>
            No se pudo cargar el dashboard.
            <ion-button fill="clear" size="small" (click)="onChangeFamily()">
              Cambiar familia
            </ion-button>
          </ion-card-content>
        </ion-card>
      </ng-container>

      <ng-container *ngIf="!isLoading && familyDashboard as dashboard">
        <ion-card class="family-card">
          <ion-card-content class="family-card-content">
            <div class="family-left">
              <ion-icon name="people-outline" class="family-icon"></ion-icon>
              <div class="family-name">{{ dashboard.familyName }}</div>
            </div>

            <div class="family-right">
              <div class="members-badge">{{ dashboard.familyMembers.length }}</div>
              <ion-button fill="clear" size="small" class="change-button" (click)="onChangeFamily()">
                Cambiar ▼
              </ion-button>
            </div>
          </ion-card-content>
        </ion-card>

        <div class="summary-grid">
          <ion-card class="summary-card">
            <ion-card-content>
              <div class="summary-header">
                <div class="summary-title">
                  <ion-icon name="cart-outline" class="summary-icon"></ion-icon>
                  Compras
                </div>
              </div>

              <div class="summary-kpi">
                <div class="summary-number">{{ shoppingPendingCount }}</div>
                <div class="summary-caption">Pendientes</div>
              </div>

              <div class="summary-rows">
                <div class="summary-row">
                  <div class="row-label">Comprados</div>
                  <div class="row-value">{{ shoppingPurchasedCount }}</div>
                </div>
                <div class="summary-row">
                  <div class="row-label">Categoría top</div>
                  <div class="row-value">{{ mostPurchasedCategoryName }}</div>
                </div>
              </div>
            </ion-card-content>
          </ion-card>

          <ion-card class="summary-card">
            <ion-card-content>
              <div class="summary-header">
                <div class="summary-title">
                  <ion-icon name="calendar-outline" class="summary-icon"></ion-icon>
                  Calendario
                </div>
              </div>

              <div class="summary-kpi">
                <div class="summary-number">{{ calendarUpcomingCount }}</div>
                <div class="summary-caption">Próximos</div>
              </div>

              <div class="summary-rows">
                <div class="summary-row">
                  <div class="row-label">Total</div>
                  <div class="row-value">{{ calendarTotalCount }}</div>
                </div>
                <div class="summary-row">
                  <div class="row-label">Pasados</div>
                  <div class="row-value">{{ calendarPastCount }}</div>
                </div>
                <div class="summary-row">
                  <div class="row-label">Categoría top</div>
                  <div class="row-value">{{ calendarMostFrequentCategoryLabel }}</div>
                </div>
              </div>
            </ion-card-content>
          </ion-card>
        </div>

        <div class="section-title">
          <ion-icon name="calendar-outline" class="section-icon"></ion-icon>
          <h3>Próximos Eventos</h3>
        </div>

        <ng-container *ngIf="upcomingEvents.length > 0; else noEvents">
          <ion-card class="event-card" *ngFor="let event of upcomingEvents">
            <ion-card-content class="event-card-content">
              <div class="event-main">
                <div class="event-name">{{ event.eventName }}</div>
                <div class="event-date">{{ formatEventDate(event.eventDate) }}</div>
              </div>
              <div class="event-chip" [style.backgroundColor]="getCategoryColor(event.eventCategory)">
                {{ getCategoryLabel(event.eventCategory) }}
              </div>
            </ion-card-content>
          </ion-card>
        </ng-container>

        <ng-template #noEvents>
          <ion-card>
            <ion-card-content>No hay eventos próximos.</ion-card-content>
          </ion-card>
        </ng-template>
      </ng-container>
    </div>
  </ion-content>
</ion-page>