<ion-page>
  <app-header [title]="'Dashboard'" [icon]="'home-outline'" [color]="'header-toolbar'">
  </app-header>

  <ion-content class="ion-padding" [scrollY]="true" style="--padding-bottom: 85px;">
    <div class="dashboard-container">
      <ng-container *ngIf="isLoading">
        <ion-card>
          <ion-card-content>Cargando...</ion-card-content>
        </ion-card>
      </ng-container>

      <ng-container *ngIf="!isLoading && loadError">
        <ion-card>
          <ion-card-content>
            No se pudo cargar el dashboard.
            <ion-button fill="clear" size="small" (click)="onChangeFamily()">
              Cambiar familia
            </ion-button>
          </ion-card-content>
        </ion-card>
      </ng-container>

      <ng-container *ngIf="!isLoading && familyDashboard as dashboard">
        <ion-card class="family-card">
          <ion-card-content class="family-card-content">
            <div class="family-left">
              <ion-icon name="people-outline" class="family-icon"></ion-icon>
              <div class="family-name">{{ dashboard.familyName }}</div>
              <div class="members-badge">{{ dashboard.familyMembers.length }}</div>
            </div>
            <div class="family-selection-span">
              <ion-button fill="clear" size="small" class="change-button" (click)="onChangeFamily()">
                Seleccionar familia ▼
              </ion-button>
            </div>
          </ion-card-content>
        </ion-card>

        <div class="section-title">
          <ion-icon name="stats-chart-outline" class="section-icon"></ion-icon>
          <h3>Este {{ currentMonth }}</h3>
        </div>

        <div class="summary-grid ion-margin-top">
          <app-dashboard-summary-card [iconName]="'cart-outline'" [title]="'Compras'"
            [mainNumber]="shoppingPendingCount" [mainCaption]="'Pendientes'" [rows]="[
              { label: 'Realizadas', value: shoppingPurchasedCount },
              { label: 'Categoría top', value: mostPurchasedCategoryName },
              {label: ' ', value: null}
            ]"></app-dashboard-summary-card>

          <app-dashboard-summary-card [iconName]="'calendar-outline'" [title]="'Calendario'"
            [mainNumber]="calendarUpcomingCount" [mainCaption]="'Próximos'" [rows]="[
              { label: 'Total', value: calendarTotalCount },
              { label: 'Asistidos', value: calendarPastCount },
              { label: 'Categoría top', value: calendarMostFrequentCategoryLabel }
            ]"></app-dashboard-summary-card>
        </div>


        <!-- Upcoming Events -->
        <div class="section-title">
          <ion-icon name="calendar-outline" class="section-icon"></ion-icon>
          <h3>Próximos Eventos</h3>
        </div>

        <ng-container *ngIf="upcomingEvents.length > 0; else noEvents">
          <app-dashboard-event-card [event]="event" *ngFor="let event of upcomingEvents"></app-dashboard-event-card>
        </ng-container>

        <ng-template #noEvents>
          <ion-card>
            <ion-card-content>No hay eventos próximos.</ion-card-content>
          </ion-card>
        </ng-template>

        <!-- Family members -->
        <div class="section-title">
          <ion-icon name="people-outline" class="section-icon"></ion-icon>
          <h3>Miembros de la Familia</h3>
        </div>
        <div class="members-list">
          <app-member-card [member]="member" *ngFor="let member of familyDashboard.familyMembers"></app-member-card>
        </div>

        <!-- Invitation Code -->
        <div class="invitation-code-section">
          <app-invitation-code-card [invitationCode]="dashboard.invitationCode"></app-invitation-code-card>
        </div>

      </ng-container>
    </div>
  </ion-content>
</ion-page>