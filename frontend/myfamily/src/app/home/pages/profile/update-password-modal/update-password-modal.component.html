<ion-header>
  <ion-toolbar color="header-toolbar">
    <ion-buttons slot="start">
      <ion-button (click)="onDismiss()">
        <ion-icon name="close" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>Cambiar Contraseña</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding" style="--padding-bottom: env(safe-area-inset-bottom, 16px);">
  <form [formGroup]="passwordForm" (ngSubmit)="onSave()">
    <!-- Hidden username field for accessibility (password manager recognition) -->
    <input type="text" autocomplete="username" style="display: none;" />

    <ion-item class="form-item">
      <ion-label position="floating">Nueva contraseña</ion-label>
      <ion-input *ngIf="!showNewPassword" type="password" formControlName="newPassword"
        autocomplete="new-password"></ion-input>
      <ion-input *ngIf="showNewPassword" type="text" formControlName="newPassword"
        autocomplete="new-password"></ion-input>
      <ion-button slot="end" fill="clear" size="small" type="button" (mousedown)="$event.preventDefault()"
        (click)="togglePasswordVisibility('newPassword')">
        <ion-icon [name]="showNewPassword ? 'eye-off-outline' : 'eye-outline'"></ion-icon>
      </ion-button>
    </ion-item>
    <ion-text color="danger" *ngIf="getPasswordError()">
      <p class="field-error">{{ getPasswordError() }}</p>
    </ion-text>

    <ion-item class="form-item">
      <ion-label position="floating">Repetir contraseña</ion-label>
      <ion-input *ngIf="!showRepeatPassword" type="password" formControlName="repeatPassword"
        autocomplete="new-password"></ion-input>
      <ion-input *ngIf="showRepeatPassword" type="text" formControlName="repeatPassword"
        autocomplete="new-password"></ion-input>
      <ion-button slot="end" fill="clear" size="small" type="button" (mousedown)="$event.preventDefault()"
        (click)="togglePasswordVisibility('repeatPassword')">
        <ion-icon [name]="showRepeatPassword ? 'eye-off-outline' : 'eye-outline'"></ion-icon>
      </ion-button>
    </ion-item>
    <ion-text color="danger" *ngIf="getRepeatPasswordError()">
      <p class="field-error">{{ getRepeatPasswordError() }}</p>
    </ion-text>

    <div class="button-group">
      <ion-button type="button" (click)="onDismiss()" fill="outline" color="medium" [disabled]="isLoading">
        <ion-icon name="close" slot="start"></ion-icon>
        Cancelar
      </ion-button>

      <ion-button type="submit" color="success" [disabled]="!passwordForm.valid || !passwordsMatch || isLoading">
        <ion-spinner *ngIf="isLoading" name="crescent" class="spinner"></ion-spinner>
        {{ isLoading ? 'Guardando...' : 'Guardar' }}
      </ion-button>
    </div>
  </form>
</ion-content>